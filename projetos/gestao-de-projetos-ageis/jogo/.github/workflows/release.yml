name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    name: Build executables and create release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            executable: jogo-plataforma
            archive_cmd: tar -czf
            archive_ext: tar.gz
          - os: windows-latest
            platform: windows
            executable: jogo-plataforma.exe
            archive_cmd: 7z a -tzip
            archive_ext: zip
          - os: macos-latest
            platform: macos
            executable: jogo-plataforma
            archive_cmd: tar -czf
            archive_ext: tar.gz

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libfreetype6-dev \
          libportmidi-dev \
          python3-dev

    - name: Install Python dependencies
      working-directory: ./projetos/gestao-de-projetos-ageis/jogo
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build executable
      working-directory: ./projetos/gestao-de-projetos-ageis/jogo
      run: |
        pyinstaller --onefile \
          --windowed \
          --add-data "imagens:imagens" \
          --name "${{ matrix.executable }}" \
          --clean \
          main.py

    - name: Prepare release package
      working-directory: ./projetos/gestao-de-projetos-ageis/jogo
      shell: bash
      run: |
        mkdir -p release-package
        cp dist/${{ matrix.executable }} release-package/

        # Create README for the release
        cat > release-package/README.txt << 'EOF'
        ==========================================
              JOGO DE PLATAFORMA v${{ github.event.inputs.tag_name || github.ref_name }}
        ==========================================

        ğŸ® COMO JOGAR:
        - Setas direcionais: Mover o personagem
        - Seta para cima: Pular
        - ENTER: Iniciar o jogo
        - ESC: Sair do jogo

        ğŸ¯ OBJETIVO:
        Atravesse as plataformas, colete moedas, desvie dos inimigos
        e espinhos, e chegue atÃ© a plataforma final com a bandeira!

        âš ï¸ CUIDADO COM:
        - Inimigos (alguns atiram!)
        - Espinhos fixos e mÃ³veis
        - Quedas no vazio

        ğŸ’– SISTEMA DE VIDA:
        VocÃª tem 3 vidas representadas pelos cÃ­rculos vermelhos
        no canto superior direito da tela.

        ğŸ† PONTUAÃ‡ÃƒO:
        - Moedas coletadas: +1 ponto cada
        - Inimigos derrotados: +5 pontos cada

        ==========================================
        Desenvolvido para a disciplina de
        GestÃ£o de Projetos Ãgeis - FATEC
        ==========================================
        EOF

        # Add execution instructions per platform
        if [ "${{ matrix.platform }}" = "windows" ]; then
          echo "" >> release-package/README.txt
          echo "ğŸš€ COMO EXECUTAR:" >> release-package/README.txt
          echo "Duplo-clique no arquivo jogo-plataforma.exe" >> release-package/README.txt
        else
          echo "" >> release-package/README.txt
          echo "ğŸš€ COMO EXECUTAR:" >> release-package/README.txt
          echo "No terminal, digite: ./jogo-plataforma" >> release-package/README.txt
          echo "Ou duplo-clique no arquivo (se suportado pelo sistema)" >> release-package/README.txt
        fi

    - name: Create archive
      working-directory: ./projetos/gestao-de-projetos-ageis/jogo
      shell: bash
      run: |
        cd release-package
        if [ "${{ matrix.platform }}" = "windows" ]; then
          7z a -tzip "../jogo-plataforma-${{ matrix.platform }}-x64.${{ matrix.archive_ext }}" .
        else
          ${{ matrix.archive_cmd }} "../jogo-plataforma-${{ matrix.platform }}-x64.${{ matrix.archive_ext }}" .
        fi

    - name: Upload build artifact
      uses: actions/upload-artifact@v3
      with:
        name: jogo-plataforma-${{ matrix.platform }}-x64
        path: ./projetos/gestao-de-projetos-ageis/jogo/jogo-plataforma-${{ matrix.platform }}-x64.${{ matrix.archive_ext }}
        retention-days: 30

  create-github-release:
    name: Create GitHub Release
    needs: build-and-release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: ./release-artifacts

    - name: List artifacts
      run: |
        echo "=== Available artifacts ==="
        find ./release-artifacts -type f -name "*.tar.gz" -o -name "*.zip" | sort
        echo "=========================="

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: "ğŸ® Jogo de Plataforma ${{ github.event.inputs.tag_name || github.ref_name }}"
        body: |
          ## ğŸ® Jogo de Plataforma - Release ${{ github.event.inputs.tag_name || github.ref_name }}

          > **Jogo desenvolvido para a disciplina de GestÃ£o de Projetos Ãgeis - FATEC**

          ### ğŸ“¦ Downloads DisponÃ­veis

          | Plataforma | Arquivo | Tamanho Aprox. |
          |------------|---------|---------------|
          | ğŸªŸ **Windows 64-bit** | `jogo-plataforma-windows-x64.zip` | ~20MB |
          | ğŸ§ **Linux 64-bit** | `jogo-plataforma-linux-x64.tar.gz` | ~20MB |
          | ğŸ **macOS 64-bit** | `jogo-plataforma-macos-x64.tar.gz` | ~20MB |

          ### ğŸš€ Como Instalar e Executar

          #### Windows:
          1. Baixe `jogo-plataforma-windows-x64.zip`
          2. Extraia o arquivo ZIP
          3. Duplo-clique em `jogo-plataforma.exe`

          #### Linux:
          1. Baixe `jogo-plataforma-linux-x64.tar.gz`
          2. Extraia: `tar -xzf jogo-plataforma-linux-x64.tar.gz`
          3. Execute: `./jogo-plataforma`

          #### macOS:
          1. Baixe `jogo-plataforma-macos-x64.tar.gz`
          2. Extraia o arquivo
          3. Execute: `./jogo-plataforma`

          ### ğŸ® Controles do Jogo

          | Tecla | AÃ§Ã£o |
          |-------|------|
          | â¬…ï¸ **Seta Esquerda** | Mover para esquerda |
          | â¡ï¸ **Seta Direita** | Mover para direita |
          | â¬†ï¸ **Seta Cima** | Pular |
          | **ENTER** | Iniciar jogo |
          | **ESC** | Sair |

          ### ğŸ¯ Objetivo do Jogo
          - Atravesse as plataformas coletando moedas
          - Desvie de inimigos e espinhos
          - Chegue atÃ© a plataforma final com a bandeira
          - VocÃª tem 3 vidas para completar o desafio!

          ### âœ¨ CaracterÃ­sticas
          - **Sistema de vidas**: 3 vidas com invencibilidade temporÃ¡ria
          - **Inimigos inteligentes**: Alguns atiram projÃ©teis!
          - **ObstÃ¡culos mÃ³veis**: Espinhos que se movem
          - **Sistema de pontuaÃ§Ã£o**: Colete moedas (+1) e derrote inimigos (+5)
          - **CÃ¢mera dinÃ¢mica**: Acompanha o jogador
          - **ExecutÃ¡vel independente**: NÃ£o requer Python instalado

          ### ğŸ› ï¸ InformaÃ§Ãµes TÃ©cnicas
          - **Engine**: Pygame 2.5.2
          - **Compilador**: PyInstaller 6.16.0
          - **Plataformas suportadas**: Windows, Linux, macOS (x64)
          - **Tamanho**: ~20MB por executÃ¡vel

          ---
          ğŸ¤– **CompilaÃ§Ã£o automÃ¡tica via GitHub Actions**
          ğŸ“… **Data de compilaÃ§Ã£o**: ${{ github.event.head_commit.timestamp }}

        files: |
          release-artifacts/**/*.zip
          release-artifacts/**/*.tar.gz
        tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}